---
title: "Biobank dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    source_code: embed
    theme: 
      version: 4
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(knitr)
library(DT)
library(rpivotTable)
library(ggplot2)
library(plotly)
library(dplyr)
library(openintro)
library(highcharter)
library(ggvis)
library(sqldf)
library(data.table)
library(shiny)
library(spData)
library(sf)
library(leaflet)
library(reshape)
library(tidyr)

```


```{r}
dataset <- read.csv("dataset.csv",header = TRUE)

specimen_type <- dataset %>% count(Specimen_Type)

#specimen_status <- dataset %>% count(Specimen_Pathological.Status)


Total_plasma <- specimen_type[specimen_type$Specimen_Type == 'Plasma' , 'n']
Total_Serum <- specimen_type[specimen_type$Specimen_Type == 'Serum', 'n']
Total_Buffy_Coat <- specimen_type[specimen_type$Specimen_Type == 'Buffy_Coat', 'n']
Total_Fresh_Tissue <- specimen_type[specimen_type$Specimen_Type == 'Fresh_Tissue' , 'n']

Total_Project <- length(unique(dataset$Project))
Total_Patients <-length(unique(dataset$Participant_PPID))

gender_df <- dataset[!duplicated(dataset[, c("Participant_PPID", "Participant_Gender")]), ]
                      

```

```{r}
mycolors <- c("blue", "#FFC125", "darkgreen", "darkorange")
```

Overall Data Visualization
=====================================

Row
-------------------------------------

### Summary dashboard

```{r}
valueBox(paste("Biobank"),
         color = "warning")
```

### Total Project

```{r}
valueBox(Total_Project,
         icon = 'fa-tasks')
```

### **Total Patients**

```{r}
valueBox(Total_Patients,
         icon = 'fa-users')

```

### Plasma

```{r}
valueBox(Total_plasma,
         icon = 'fa-tint')
```

### Serum

```{r}
valueBox(Total_Serum,
         icon = 'fa-burn')
```

### Buffy coat

```{r}
valueBox(Total_Buffy_Coat,
         icon = 'fa-vial')
```

### Fresh Tissue

```{r}
valueBox(Total_Fresh_Tissue,
         icon = 'fa-diagnoses')
```

Row
-------------------------------

### Pie chart from Specimen_Type

```{r}

dataset %>%
  count(Specimen_Type) %>% 
  plot_ly(labels = ~Specimen_Type, values = ~n, type = "pie")


``` 



### Pie chart from Specimen_Pathological.Status 

```{r}

dataset %>%
  count(Specimen_Pathological.Status)%>% hchart("pie", hcaes(x= Specimen_Pathological.Status, y=n), name = "Pie chart from Specimen_Pathological.Status ")
#dataset %>%
 # count(Specimen_Pathological.Status) %>% 
 # plot_ly(labels = ~Specimen_Pathological.Status, #values = ~n, type = "pie")

```

### Piecharts of gender
```{r}
dataset %>%
  count(Participant_PPID, Participant_Gender) %>% 
  plot_ly(labels = ~Participant_Gender, type = "pie")

```


### Project in each years

```{r}

dataset$Year.f <- factor(dataset$Year)
p <- ggplot(dataset, aes(x = Year.f, y = Project, color = Specimen_Type)) +
  geom_jitter(width = 0.3, height = 0.4, alpha = 0.5) + ylab("Years")
ggplotly(p)


```

Row
------------------------------------
### #line graph specimen type in each year

```{r}
dataset %>%
  count(Year.f, Specimen_Type) %>% 
  plot_ly(x = ~Year.f, y = ~n, color = ~Specimen_Type, type = "scatter", mode = "lines+markers")

```

### barchart each specimen type group by project
```{r}

dataset %>% count(Project,Specimen_Type) %>% hchart('column', hcaes(x = Project, y = n, group = Specimen_Type)) %>% hc_colors(c("#D79922","#F13C20" ,"#4056A1", "#53900F"))

```

Query
========================================

### query group by year project 


```{r}

df <- sqldf("SELECT Year,Project,COUNT(*) AS Total_samples,COUNT(DISTINCT Participant_PPID) AS Total_patients,
            SUM(CASE WHEN Specimen_Type = 'Plasma' THEN 1 ELSE 0 END) as Plasma,
            SUM(CASE WHEN Specimen_Type = 'Serum' THEN 1 ELSE 0 END) as Serum,
            SUM(CASE WHEN Specimen_Type = 'Buffy_Coat' THEN 1 ELSE 0 END) as Buffy_Coat,
            SUM(CASE WHEN Specimen_Type = 'Fresh_Tissue' THEN 1 ELSE 0 END) as Fresh_Tissue,
            SUM(CASE WHEN [Specimen_Pathological.Status] = 'Non-Malignant' THEN 1 ELSE 0 END) as Normal_Tissue,
            SUM(CASE WHEN [Specimen_Pathological.Status] = 'Malignant' THEN 1 ELSE 0 END) as Diseased_Tissue,
            SUM(CASE WHEN [Specimen_Pathological.Status] = 'Not Specified' THEN 1 ELSE 0 END) as Not_Specified
            FROM dataset
            GROUP BY Year,Project
            ");

data_melt <-melt(df %>% select(Year,Project,Plasma,Serum,Buffy_Coat,Fresh_Tissue),id = c("Year","Project"))



```

Column {.sidebar data-width=200}
-------------------------------------------------------------------
```{r}

selectInput(inputId="year", label = "Select Year:", choices = unique(dataset$Year))

selectInput(inputId="project", label = "Select Project:", choices = unique(dataset$Project) %>% sort())

```

Column {data-width=400}
-------------------------------------------------------------------

```{r}

renderHighchart( {
    
    # Filter data based on selected Style
    if (input$year != "All") {
      data_melt <- filter(data_melt, Year == input$year)
    }
    
    # Filter data based on selected Country
    if (input$project != "All") {
      data_melt <- filter(data_melt, Project == input$project)
    }
    
    # Error message for when user has filtered out all data
    validate (
      need(nrow(data_melt) > 0, "No data found. Please make another selection.")
    )
    
    # Get top 20 brands
    specimens <- group_by(data_melt, variable) %>% 
      summarise(sumValue = sum(value)) %>% 
      arrange(desc(sumValue))
    
    # Bar chart
    hc <- specimens %>% hchart('column', hcaes(x = variable, y = sumValue, color = variable))
    hc

  })

```

### Pie chart
```{r}
renderPlot( {
    
    # Filter data based on selected Style
    if (input$year != "All") {
      gender_df <- filter(gender_df, Year == input$year)
    }
    
    # Filter data based on selected Country
    if (input$project != "All") {
      gender_df <- filter(gender_df, Project == input$project)
    }
    
    # Error message for when user has filtered out all data
    validate (
      need(nrow(gender_df) > 0, "No data found. Please make another selection.")
    )
    
    # Get sum of each gender
    gend <- as.data.frame(table(gender_df$Participant_Gender))
  gend <- gend %>% mutate(per=Freq/sum(Freq)) %>% arrange(desc(Var1))
  gend$label <- scales::percent(gend$per)
    
    #plot Pie chart
    ggplot(data =gend)+geom_bar(aes(x='',y=per,fill=Var1), stat='identity', width = 1)+coord_polar("y",start=0)+ theme_void()+geom_text(aes(x=1,y=cumsum(per)- per/2,label=label))+ggtitle("Gender Pie chart")
    #ggplot(gend, aes(x="", y=Freq, fill=Var1)) +
     # geom_bar(stat="identity", width=1) +
      #coord_polar("y", start=0)

  })

```

Column {data-width=400}
-------------------------------------------------------------------

### summary table
```{r}

 renderDataTable({
    
    # Filter data based on selected Style
    if (input$year != "All") {
      data_melt <- filter(data_melt, Year == input$year)
    }
    
    # Filter data based on selected Country
    if (input$project != "All") {
      data_melt <- filter(data_melt, Project == input$project)
    }
    
    # Hide table when user has filtered out all data
    validate (
      need(nrow(data_melt) > 0, "")
    )
    
    data_melt[,]
    
  })
```



Table
=========================================

```{r}
DT::datatable(df, options = list(
  bPaginate = FALSE
))
```

Blank {data-orientation=columns} 
===========================================

Column 
-----------------------------------

### Block

```{r}

```

### Block
```{r}

```

### Block

```{r}

```

Column
---------------------------

Report


About Report
========================================

Credit by: 

Confidential: Normal




